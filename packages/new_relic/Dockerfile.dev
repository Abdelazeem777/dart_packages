
FROM golang:1.13.8-buster as newrelic-sdk-builder

RUN apt-get update && apt-get install build-essential libpcre3-dev -y

RUN wget https://github.com/newrelic/c-sdk/archive/v1.3.0.tar.gz

RUN tar xfvz v1.3.0.tar.gz

WORKDIR /go/c-sdk-1.3.0

RUN make libnewrelic.a && pwd && ls -lah

RUN ar -x libnewrelic.a
RUN ls -lah
RUN gcc -shared *.o -o libnewrelic.so -lpcre -lm -pthread -rdynamic
RUN ls -lah


FROM google/dart:2.8.4

WORKDIR /app

ADD pubspec.* /app/
RUN ls -lah
RUN pub get
ADD . /app
RUN pub get --offline
COPY --from=newrelic-sdk-builder /go/c-sdk-1.3.0/libnewrelic.so /app/libnewrelic.so

CMD []
ENTRYPOINT ["/usr/bin/dart", "example/sample.dart"]